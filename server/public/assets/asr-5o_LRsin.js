var M=Object.defineProperty;var T=(r,e,n)=>e in r?M(r,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[e]=n;var b=(r,e,n)=>T(r,typeof e!="symbol"?e+"":e,n);function L(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var C={exports:{}};/*!
 * 
 * js-audio-recorder - js audio recorder plugin
 * 
 * @version v1.0.7
 * @homepage https://github.com/2fps/recorder
 * @author 2fps <echoweb@126.com> (https://www.zhuyuntao.cn)
 * @license MIT
 *         
 */var D=C.exports,P;function B(){return P||(P=1,function(r,e){(function(n,a){r.exports=a()})(D,function(){return function(n){var a={};function o(i){if(a[i])return a[i].exports;var s=a[i]={i,l:!1,exports:{}};return n[i].call(s.exports,s,s.exports,o),s.l=!0,s.exports}return o.m=n,o.c=a,o.d=function(i,s,u){o.o(i,s)||Object.defineProperty(i,s,{enumerable:!0,get:u})},o.r=function(i){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},o.t=function(i,s){if(1&s&&(i=o(i)),8&s||4&s&&typeof i=="object"&&i&&i.__esModule)return i;var u=Object.create(null);if(o.r(u),Object.defineProperty(u,"default",{enumerable:!0,value:i}),2&s&&typeof i!="string")for(var t in i)o.d(u,t,(function(c){return i[c]}).bind(null,t));return u},o.n=function(i){var s=i&&i.__esModule?function(){return i.default}:function(){return i};return o.d(s,"a",s),s},o.o=function(i,s){return Object.prototype.hasOwnProperty.call(i,s)},o.p="",o(o.s=1)}([function(n,a,o){function i(s,u,t){for(var c=0;c<t.length;c++)s.setUint8(u+c,t.charCodeAt(c))}Object.defineProperty(a,"__esModule",{value:!0}),a.compress=function(s,u,t){for(var c=u/t,g=Math.max(c,1),h=s.left,f=s.right,l=Math.floor((h.length+f.length)/c),d=new Float32Array(l),p=0,v=0;p<l;){var y=Math.floor(v);d[p]=h[y],p++,f.length&&(d[p]=f[y],p++),v+=g}return d},a.encodePCM=function(s,u,t){t===void 0&&(t=!0);var c=0,g=s.length*(u/8),h=new ArrayBuffer(g),f=new DataView(h);if(u===8)for(var l=0;l<s.length;l++,c++){var d=(p=Math.max(-1,Math.min(1,s[l])))<0?128*p:127*p;d=+d+128,f.setInt8(c,d)}else for(l=0;l<s.length;l++,c+=2){var p=Math.max(-1,Math.min(1,s[l]));f.setInt16(c,p<0?32768*p:32767*p,t)}return f},a.encodeWAV=function(s,u,t,c,g,h){h===void 0&&(h=!0);var f=t>u?u:t,l=g,d=new ArrayBuffer(44+s.byteLength),p=new DataView(d),v=c,y=0;i(p,y,"RIFF"),y+=4,p.setUint32(y,36+s.byteLength,h),i(p,y+=4,"WAVE"),i(p,y+=4,"fmt "),y+=4,p.setUint32(y,16,h),y+=4,p.setUint16(y,1,h),y+=2,p.setUint16(y,v,h),y+=2,p.setUint32(y,f,h),y+=4,p.setUint32(y,v*f*(l/8),h),y+=4,p.setUint16(y,v*(l/8),h),y+=2,p.setUint16(y,l,h),i(p,y+=2,"data"),y+=4,p.setUint32(y,s.byteLength,h),y+=4;for(var m=0;m<s.byteLength;)p.setUint8(y,s.getUint8(m)),y++,m++;return p}},function(n,a,o){var i,s=this&&this.__extends||(i=function(h,f){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(l,d){l.__proto__=d}||function(l,d){for(var p in d)d.hasOwnProperty(p)&&(l[p]=d[p])})(h,f)},function(h,f){function l(){this.constructor=h}i(h,f),h.prototype=f===null?Object.create(f):(l.prototype=f.prototype,new l)});Object.defineProperty(a,"__esModule",{value:!0});var u=o(2),t=o(0),c=o(3),g=function(h){function f(l){l===void 0&&(l={});var d=h.call(this,l)||this;return d.isrecording=!1,d.ispause=!1,d.isplaying=!1,d}return s(f,h),f.prototype.setOption=function(l){l===void 0&&(l={}),this.setNewOption(l)},f.prototype.start=function(){return this.isrecording?Promise.reject():(this.isrecording=!0,this.startRecord())},f.prototype.pause=function(){this.isrecording&&!this.ispause&&(this.ispause=!0,this.pauseRecord())},f.prototype.resume=function(){this.isrecording&&this.ispause&&(this.ispause=!1,this.resumeRecord())},f.prototype.stop=function(){this.isrecording&&(this.isrecording=!1,this.ispause=!1,this.stopRecord())},f.prototype.play=function(){this.stop(),this.isplaying=!0,this.onplay&&this.onplay(),c.default.addPlayEnd(this.onplayend);var l=this.getWAV();l.byteLength>44&&c.default.play(l.buffer)},f.prototype.getPlayTime=function(){return c.default.getPlayTime()},f.prototype.pausePlay=function(){!this.isrecording&&this.isplaying&&(this.isplaying=!1,this.onpauseplay&&this.onpauseplay(),c.default.pausePlay())},f.prototype.resumePlay=function(){this.isrecording||this.isplaying||(this.isplaying=!0,this.onresumeplay&&this.onresumeplay(),c.default.resumePlay())},f.prototype.stopPlay=function(){this.isrecording||(this.isplaying=!1,this.onstopplay&&this.onstopplay(),c.default.stopPlay())},f.prototype.destroy=function(){return c.default.destroyPlay(),this.destroyRecord()},f.prototype.getRecordAnalyseData=function(){return this.getAnalyseData()},f.prototype.getPlayAnalyseData=function(){return c.default.getAnalyseData()},f.prototype.getPCM=function(){this.stop();var l=this.getData();return l=t.compress(l,this.inputSampleRate,this.outputSampleRate),t.encodePCM(l,this.oututSampleBits,this.littleEdian)},f.prototype.getPCMBlob=function(){return new Blob([this.getPCM()])},f.prototype.downloadPCM=function(l){l===void 0&&(l="recorder");var d=this.getPCMBlob();u.downloadPCM(d,l)},f.prototype.getWAV=function(){var l=this.getPCM();return t.encodeWAV(l,this.inputSampleRate,this.outputSampleRate,this.config.numChannels,this.oututSampleBits,this.littleEdian)},f.prototype.getWAVBlob=function(){return new Blob([this.getWAV()],{type:"audio/wav"})},f.prototype.downloadWAV=function(l){l===void 0&&(l="recorder");var d=this.getWAVBlob();u.downloadWAV(d,l)},f.prototype.download=function(l,d,p){u.download(l,d,p)},f.prototype.getChannelData=function(){var l=this.getPCM(),d=l.byteLength,p=this.littleEdian,v={left:null,right:null};if(this.config.numChannels===2){var y=new DataView(new ArrayBuffer(d/2)),m=new DataView(new ArrayBuffer(d/2));if(this.config.sampleBits===16)for(var _=0;_<d/2;_+=2)y.setInt16(_,l.getInt16(2*_,p),p),m.setInt16(_,l.getInt16(2*_+2,p),p);else for(_=0;_<d/2;_+=2)y.setInt8(_,l.getInt8(2*_)),m.setInt8(_,l.getInt8(2*_+1));v.left=y,v.right=m}else v.left=l;return v},f}(o(5).default);a.default=g},function(n,a,o){function i(s,u,t){var c=document.createElement("a");c.href=window.URL.createObjectURL(s),c.download=u+"."+t,c.click()}Object.defineProperty(a,"__esModule",{value:!0}),a.downloadWAV=function(s,u){u===void 0&&(u="recorder"),i(s,u,"wav")},a.downloadPCM=function(s,u){u===void 0&&(u="recorder"),i(s,u,"pcm")},a.download=function(s,u,t){return i(s,u,t)}},function(n,a,o){Object.defineProperty(a,"__esModule",{value:!0});var i=o(4),s=null,u=0,t=0,c=null,g=null,h=null,f=!1,l=0,d=function(){};function p(){return f=!1,c.decodeAudioData(h.slice(0),function(m){(s=c.createBufferSource()).onended=function(){f||(l=c.currentTime-t+u,d())},s.buffer=m,s.connect(g),g.connect(c.destination),s.start(0,u),t=c.currentTime},function(m){i.throwError(m)})}function v(){s&&(s.stop(),s=null)}var y=function(){function m(){}return m.play=function(_){return c||(c=new(window.AudioContext||window.webkitAudioContext),(g=c.createAnalyser()).fftSize=2048),this.stopPlay(),h=_,l=0,p()},m.pausePlay=function(){v(),u+=c.currentTime-t,f=!0},m.resumePlay=function(){return p()},m.stopPlay=function(){u=0,h=null,v()},m.destroyPlay=function(){this.stopPlay()},m.getAnalyseData=function(){var _=new Uint8Array(g.frequencyBinCount);return g.getByteTimeDomainData(_),_},m.addPlayEnd=function(_){_===void 0&&(_=function(){}),d=_},m.getPlayTime=function(){var _=f?u:c.currentTime-t+u;return l||_},m}();a.default=y},function(n,a,o){Object.defineProperty(a,"__esModule",{value:!0}),a.throwError=function(i){throw new Error(i)}},function(n,a,o){Object.defineProperty(a,"__esModule",{value:!0});var i=o(0),s=function(){function u(t){t===void 0&&(t={}),this.size=0,this.lBuffer=[],this.rBuffer=[],this.tempPCM=[],this.inputSampleBits=16,this.fileSize=0,this.duration=0,this.needRecord=!0;var c,g=new(window.AudioContext||window.webkitAudioContext);this.inputSampleRate=g.sampleRate,this.setNewOption(t),this.littleEdian=(c=new ArrayBuffer(2),new DataView(c).setInt16(0,256,!0),new Int16Array(c)[0]===256),u.initUserMedia()}return u.prototype.setNewOption=function(t){t===void 0&&(t={}),this.config={sampleBits:~[8,16].indexOf(t.sampleBits)?t.sampleBits:16,sampleRate:~[8e3,11025,16e3,22050,24e3,44100,48e3].indexOf(t.sampleRate)?t.sampleRate:this.inputSampleRate,numChannels:~[1,2].indexOf(t.numChannels)?t.numChannels:1},this.outputSampleRate=this.config.sampleRate,this.oututSampleBits=this.config.sampleBits},u.prototype.startRecord=function(){var t=this;return this.context&&this.destroyRecord(),this.initRecorder(),navigator.mediaDevices.getUserMedia({audio:!0}).then(function(c){t.audioInput=t.context.createMediaStreamSource(c),t.stream=c}).then(function(){t.audioInput.connect(t.analyser),t.analyser.connect(t.recorder),t.recorder.connect(t.context.destination)})},u.prototype.pauseRecord=function(){this.needRecord=!1},u.prototype.resumeRecord=function(){this.needRecord=!0},u.prototype.stopRecord=function(){this.audioInput&&this.audioInput.disconnect(),this.source&&this.source.stop(),this.recorder.disconnect(),this.analyser.disconnect(),this.needRecord=!0},u.prototype.destroyRecord=function(){return this.clearRecordStatus(),this.stopStream(),this.closeAudioContext()},u.prototype.getAnalyseData=function(){var t=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteTimeDomainData(t),t},u.prototype.getData=function(){return this.flat()},u.prototype.clearRecordStatus=function(){this.lBuffer.length=0,this.rBuffer.length=0,this.size=0,this.fileSize=0,this.PCM=null,this.audioInput=null,this.duration=0},u.prototype.flat=function(){var t=null,c=new Float32Array(0);this.config.numChannels===1?t=new Float32Array(this.size):(t=new Float32Array(this.size/2),c=new Float32Array(this.size/2));for(var g=0,h=0;h<this.lBuffer.length;h++)t.set(this.lBuffer[h],g),g+=this.lBuffer[h].length;for(g=0,h=0;h<this.rBuffer.length;h++)c.set(this.rBuffer[h],g),g+=this.rBuffer[h].length;return{left:t,right:c}},u.prototype.initRecorder=function(){var t=this;this.clearRecordStatus(),this.context=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.context.createAnalyser(),this.analyser.fftSize=2048;var c=this.context.createScriptProcessor||this.context.createJavaScriptNode;this.recorder=c.apply(this.context,[4096,this.config.numChannels,this.config.numChannels]),this.recorder.onaudioprocess=function(g){if(t.needRecord){var h,f=g.inputBuffer.getChannelData(0),l=null;t.lBuffer.push(new Float32Array(f)),t.size+=f.length,t.config.numChannels===2&&(l=g.inputBuffer.getChannelData(1),t.rBuffer.push(new Float32Array(l)),t.size+=l.length),t.fileSize=Math.floor(t.size/Math.max(t.inputSampleRate/t.outputSampleRate,1))*(t.oututSampleBits/8),h=100*Math.max.apply(Math,f),t.duration+=4096/t.inputSampleRate,t.onprocess&&t.onprocess(t.duration),t.onprogress&&t.onprogress({duration:t.duration,fileSize:t.fileSize,vol:h})}}},u.prototype.stopStream=function(){this.stream&&this.stream.getTracks&&(this.stream.getTracks().forEach(function(t){return t.stop()}),this.stream=null)},u.prototype.closeAudioContext=function(){return this.context&&this.context.close&&this.context.state!=="closed"?this.context.close():new Promise(function(t){t()})},u.initUserMedia=function(){navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(t){var c=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return c?new Promise(function(g,h){c.call(navigator,t,g,h)}):Promise.reject(new Error("浏览器不支持 getUserMedia !"))})},u.prototype.transformIntoPCM=function(t,c){var g=new Float32Array(t),h=new Float32Array(c),f=i.compress({left:g,right:h},this.inputSampleRate,this.outputSampleRate);return i.encodePCM(f,this.oututSampleBits,this.littleEdian)},u.getPermission=function(){return this.initUserMedia(),navigator.mediaDevices.getUserMedia({audio:!0}).then(function(t){t&&t.getTracks().forEach(function(c){return c.stop()})})},u}();a.default=s}]).default})}(C)),C.exports}var E,R;function j(){return R||(R=1,E=B()),E}var U=j();const S=L(U);/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var x=function(r,e){return x=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,a){n.__proto__=a}||function(n,a){for(var o in a)a.hasOwnProperty(o)&&(n[o]=a[o])},x(r,e)};function O(r,e){x(r,e);function n(){this.constructor=r}r.prototype=e===null?Object.create(e):(n.prototype=e.prototype,new n)}function I(r){var e=typeof Symbol=="function"&&r[Symbol.iterator],n=0;return e?e.call(r):{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}}}function N(r,e){var n=typeof Symbol=="function"&&r[Symbol.iterator];if(!n)return r;var a=n.call(r),o,i=[],s;try{for(;(e===void 0||e-- >0)&&!(o=a.next()).done;)i.push(o.value)}catch(u){s={error:u}}finally{try{o&&!o.done&&(n=a.return)&&n.call(a)}finally{if(s)throw s.error}}return i}function k(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat(N(arguments[e]));return r}var A=function(){function r(e,n){this.target=n,this.type=e}return r}(),W=function(r){O(e,r);function e(n,a){var o=r.call(this,"error",a)||this;return o.message=n.message,o.error=n,o}return e}(A),V=function(r){O(e,r);function e(n,a,o){n===void 0&&(n=1e3),a===void 0&&(a="");var i=r.call(this,"close",o)||this;return i.wasClean=!0,i.code=n,i.reason=a,i}return e}(A);/*!
 * Reconnecting WebSocket
 * by Pedro Ladaria <pedro.ladaria@gmail.com>
 * https://github.com/pladaria/reconnecting-websocket
 * License MIT
 */var z=function(){if(typeof WebSocket<"u")return WebSocket},F=function(r){return typeof r<"u"&&!!r&&r.CLOSING===2},w={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+Math.random()*4e3,minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0},G=function(){function r(e,n,a){var o=this;a===void 0&&(a={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(i){o._debug("open event");var s=o._options.minUptime,u=s===void 0?w.minUptime:s;clearTimeout(o._connectTimeout),o._uptimeTimeout=setTimeout(function(){return o._acceptOpen()},u),o._ws.binaryType=o._binaryType,o._messageQueue.forEach(function(t){return o._ws.send(t)}),o._messageQueue=[],o.onopen&&o.onopen(i),o._listeners.open.forEach(function(t){return o._callEventListener(i,t)})},this._handleMessage=function(i){o._debug("message event"),o.onmessage&&o.onmessage(i),o._listeners.message.forEach(function(s){return o._callEventListener(i,s)})},this._handleError=function(i){o._debug("error event",i.message),o._disconnect(void 0,i.message==="TIMEOUT"?"timeout":void 0),o.onerror&&o.onerror(i),o._debug("exec error listeners"),o._listeners.error.forEach(function(s){return o._callEventListener(i,s)}),o._connect()},this._handleClose=function(i){o._debug("close event"),o._clearTimeouts(),o._shouldReconnect&&o._connect(),o.onclose&&o.onclose(i),o._listeners.close.forEach(function(s){return o._callEventListener(i,s)})},this._url=e,this._protocols=n,this._options=a,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(r,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(r,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(r,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(r,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"CONNECTING",{get:function(){return r.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"OPEN",{get:function(){return r.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"CLOSING",{get:function(){return r.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"CLOSED",{get:function(){return r.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bufferedAmount",{get:function(){var e=this._messageQueue.reduce(function(n,a){return typeof a=="string"?n+=a.length:a instanceof Blob?n+=a.size:n+=a.byteLength,n},0);return e+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?r.CLOSED:r.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),r.prototype.close=function(e,n){if(e===void 0&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),!this._ws){this._debug("close enqueued: no ws instance");return}if(this._ws.readyState===this.CLOSED){this._debug("close: already closed");return}this._ws.close(e,n)},r.prototype.reconnect=function(e,n){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,!this._ws||this._ws.readyState===this.CLOSED?this._connect():(this._disconnect(e,n),this._connect())},r.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var n=this._options.maxEnqueuedMessages,a=n===void 0?w.maxEnqueuedMessages:n;this._messageQueue.length<a&&(this._debug("enqueue",e),this._messageQueue.push(e))}},r.prototype.addEventListener=function(e,n){this._listeners[e]&&this._listeners[e].push(n)},r.prototype.dispatchEvent=function(e){var n,a,o=this._listeners[e.type];if(o)try{for(var i=I(o),s=i.next();!s.done;s=i.next()){var u=s.value;this._callEventListener(e,u)}}catch(t){n={error:t}}finally{try{s&&!s.done&&(a=i.return)&&a.call(i)}finally{if(n)throw n.error}}return!0},r.prototype.removeEventListener=function(e,n){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(a){return a!==n}))},r.prototype._debug=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this._options.debug&&console.log.apply(console,k(["RWS>"],e))},r.prototype._getNextDelay=function(){var e=this._options,n=e.reconnectionDelayGrowFactor,a=n===void 0?w.reconnectionDelayGrowFactor:n,o=e.minReconnectionDelay,i=o===void 0?w.minReconnectionDelay:o,s=e.maxReconnectionDelay,u=s===void 0?w.maxReconnectionDelay:s,t=0;return this._retryCount>0&&(t=i*Math.pow(a,this._retryCount-1),t>u&&(t=u)),this._debug("next delay",t),t},r.prototype._wait=function(){var e=this;return new Promise(function(n){setTimeout(n,e._getNextDelay())})},r.prototype._getNextUrl=function(e){if(typeof e=="string")return Promise.resolve(e);if(typeof e=="function"){var n=e();if(typeof n=="string")return Promise.resolve(n);if(n.then)return n}throw Error("Invalid URL")},r.prototype._connect=function(){var e=this;if(!(this._connectLock||!this._shouldReconnect)){this._connectLock=!0;var n=this._options,a=n.maxRetries,o=a===void 0?w.maxRetries:a,i=n.connectionTimeout,s=i===void 0?w.connectionTimeout:i,u=n.WebSocket,t=u===void 0?z():u;if(this._retryCount>=o){this._debug("max retries reached",this._retryCount,">=",o);return}if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),!F(t))throw Error("No valid WebSocket class provided");this._wait().then(function(){return e._getNextUrl(e._url)}).then(function(c){e._closeCalled||(e._debug("connect",{url:c,protocols:e._protocols}),e._ws=e._protocols?new t(c,e._protocols):new t(c),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout(function(){return e._handleTimeout()},s))})}},r.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new W(Error("TIMEOUT"),this))},r.prototype._disconnect=function(e,n){if(e===void 0&&(e=1e3),this._clearTimeouts(),!!this._ws){this._removeListeners();try{this._ws.close(e,n),this._handleClose(new V(e,n,this))}catch{}}},r.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},r.prototype._callEventListener=function(e,n){"handleEvent"in n?n.handleEvent(e):n(e)},r.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},r.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},r.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},r}();class q{constructor(){b(this,"onopen",()=>{});b(this,"ontext",e=>{});b(this,"onerror",()=>{});b(this,"onclose",()=>{});this.recorder=new S({sampleBits:16,sampleRate:16e3,numChannels:1}),this.fulltext=""}connect(){this.wsurl=localStorage.getItem("asrurl"),this.wsurl&&(this.ws=new G(this.wsurl),this.ws.addEventListener("open",()=>{console.log("ASR服务连接成功");const e={mode:"offline",chunk_size:[5,10,5],is_speaking:!1};this.ws.send(JSON.stringify(e)),this.onopen()}),this.ws.addEventListener("message",e=>{const n=JSON.parse(e.data);n.text&&(this.fulltext+=n.text),n.is_final&&(this.fulltext=this.fulltext.replace(/<\|.*?\|>/g,""),this.ontext(this.fulltext),this.fulltext="")}),this.ws.addEventListener("error",e=>{console.log("ASR服务连接错误",e),this.onerror(e)}),this.ws.addEventListener("close",()=>{console.log("ASR服务连接关闭"),this.onclose()}))}isConnected(){return!!this.ws}getPermission(){return S.getPermission()}start(e=()=>{},n=()=>{}){this.recorder.start().then(()=>{console.log("录音开始"),e()},()=>{console.log("录音开始失败"),n()})}stop(e=()=>{},n=!1){if(console.log("录音结束"),n){const a=(i,s=1024)=>{this.ws.send(JSON.stringify({is_speaking:!0}));let u=0;const t=Math.ceil(i.size/s);for(let c=0;c<t;c++){const g=u+s,h=i.slice(u,g);this.ws.send(h),u=g}this.ws.send(JSON.stringify({is_speaking:!1}))};this.recorder.stop();const o=this.recorder.getWAVBlob();a(o)}else this.recorder.stop();e()}getWAVBlob(){return this.recorder.getWAVBlob()}}const Q=new q;export{Q as a};
